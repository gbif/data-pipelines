## Interpreted Results Comparison
### Objective
This note helps to compare interpretation results for two different interpretation pipelines. This is written mainly to validate and verify the changes by the older and newer pipelines.

### Environment
The entire steps can be reproduced in the hive. The old pipelines after completion of crawl and interpretation phase keeps the records in hbase before being indexed by solr. The interpreted records in hbase table are periodically synced in the hive table {dev/uat}.occurrence_hbase.

Interpreted records from new pipelines are generated as avro records at /data/ingest/{datasetid}/{attempt_no}/verbatim.avro.

###Steps for comparison are as follows:

1. Create a table on the interpreted records created by new pipeline.

`CREATE EXTERNAL TABLE {userdb}.newpipelineinterpreted_{datasetid}
ROW FORMAT SERDE 'org.apache.hadoop.hive.serde2.avro.AvroSerDe'
STORED as INPUTFORMAT 'org.apache.hadoop.hive.ql.io.avro.AvroContainerInputFormat'
OUTPUTFORMAT 'org.apache.hadoop.hive.ql.io.avro.AvroContainerOutputFormat'
LOCATION 'hdfs://ha-nn/data/ingest/{datasetid}/{attempt_no}'
TBLPROPERTIES ('avro.schema.url'= 'hdfs://ha-nn/pipelines/avroschemas/dwca.avsc')`

2. Create another table from the interpretation of old pipeline available in occurrence_hbase table.

`CREATE TABLE {userdb}.oldpipelineinterpreted_{datasetid} ROW FORMAT DELIMITED FIELDS TERMINATED BY ',' LINES TERMINATED BY '\n' as select
  abstract,
  accessrights,
  accrualmethod,
  accrualperiodicity,
  accrualpolicy,
  alternative,
  audience,
  available,
  bibliographiccitation,
  conformsto,
  contributor,
  coverage,
  created,
  creator,
  date_,
  dateaccepted,
  datecopyrighted,
  datesubmitted,
  description,
  educationlevel,
  extent,
  format_,
  hasformat,
  haspart,
  hasversion,
  identifier,
  instructionalmethod,
  isformatof,
  ispartof,
  isreferencedby,
  isreplacedby,
  isrequiredby,
  isversionof,
  issued,
  language,
  license,
  mediator,
  medium,
  modified,
  provenance,
  publisher,
  references,
  relation,
  replaces,
  requires,
  rights,
  rightsholder,
  source,
  spatial,
  subject,
  tableofcontents,
  temporal,
  title,
  type,
  valid,
  institutionid,
  collectionid,
  datasetid,
  institutioncode,
  collectioncode,
  datasetname,
  ownerinstitutioncode,
  basisofrecord,
  informationwithheld,
  datageneralizations,
  dynamicproperties,
  occurrenceid,
  catalognumber,
  recordnumber,
  recordedby,
  individualcount,
  organismquantity,
  organismquantitytype,
  sex,
  lifestage,
  reproductivecondition,
  behavior,
  establishmentmeans,
  occurrencestatus,
  preparations,
  disposition,
  associatedreferences,
  associatedsequences,
  associatedtaxa,
  othercatalognumbers,
  occurrenceremarks,
  organismid,
  organismname,
  organismscope,
  associatedoccurrences,
  associatedorganisms,
  previousidentifications,
  organismremarks,
  materialsampleid,
  eventid,
  parenteventid,
  fieldnumber,
  eventdate,
  eventtime,
  startdayofyear,
  enddayofyear,
  year,
  month,
  day,
  verbatimeventdate,
  habitat,
  samplingprotocol,
  samplingeffort,
  samplesizevalue,
  samplesizeunit,
  fieldnotes,
  eventremarks,
  locationid,
  highergeographyid,
  highergeography,
  continent,
  waterbody,
  islandgroup,
  island,
  countrycode,
  stateprovince,
  county,
  municipality,
  locality,
  verbatimlocality,
  verbatimelevation,
  verbatimdepth,
  minimumdistanceabovesurfaceinmeters,
  maximumdistanceabovesurfaceinmeters,
  locationaccordingto,
  locationremarks,
  decimallatitude,
  decimallongitude,
  coordinateuncertaintyinmeters,
  coordinateprecision,
  pointradiusspatialfit,
  verbatimcoordinatesystem,
  verbatimsrs,
  footprintwkt,
  footprintsrs,
  footprintspatialfit,
  georeferencedby,
  georeferenceddate,
  georeferenceprotocol,
  georeferencesources,
  georeferenceverificationstatus,
  georeferenceremarks,
  geologicalcontextid,
  earliesteonorlowesteonothem,
  latesteonorhighesteonothem,
  earliesteraorlowesterathem,
  latesteraorhighesterathem,
  earliestperiodorlowestsystem,
  latestperiodorhighestsystem,
  earliestepochorlowestseries,
  latestepochorhighestseries,
  earliestageorloweststage,
  latestageorhigheststage,
  lowestbiostratigraphiczone,
  highestbiostratigraphiczone,
  lithostratigraphicterms,
  group_,
  formation,
  member,
  bed,
  identificationid,
  identificationqualifier,
  typestatus,
  identifiedby,
  dateidentified,
  identificationreferences,
  identificationverificationstatus,
  identificationremarks,
  taxonid,
  scientificnameid,
  acceptednameusageid,
  parentnameusageid,
  originalnameusageid,
  nameaccordingtoid,
  namepublishedinid,
  taxonconceptid,
  scientificname,
  acceptednameusage,
  parentnameusage,
  originalnameusage,
  nameaccordingto,
  namepublishedin,
  namepublishedinyear,
  higherclassification,
  kingdom,
  phylum,
  class,
  order_,
  family,
  genus,
  subgenus,
  specificepithet,
  infraspecificepithet,
  taxonrank,
  verbatimtaxonrank,
  vernacularname,
  nomenclaturalcode,
  taxonomicstatus,
  nomenclaturalstatus,
  taxonremarks,
  datasetkey,
  publishingcountry,
  lastinterpreted,
  elevation,
  elevationaccuracy,
  depth,
  depthaccuracy,
  distanceabovesurface,
  distanceabovesurfaceaccuracy,
  hascoordinate,
  hasgeospatialissues,
  taxonkey,
  kingdomkey,
  phylumkey,
  classkey,
  orderkey,
  familykey,
  genuskey,
  subgenuskey,
  specieskey,
  species,
  genericname,
  typifiedname,
  protocol,
  lastparsed,
  lastcrawled,
  repatriated from {dev/uat}.occurrence_hbase where datasetkey = '{datasetid}';`

  3. Join query between the two interpreted record table mentioned above.

  `SELECT a.id newid,b.occurrenceid oldid, a.coreterms["http://rs.tdwg.org/dwc/terms/sex"] new_sex,b.sex old_sex,
  a.coreterms["http://rs.tdwg.org/dwc/terms/basisOfRecord"] new_basisofrecord,b.basisofrecord old_basisofrecord,
  a.coreterms["http://rs.tdwg.org/dwc/terms/countryCode"] new_country,b.countrycode old_countrycode,
  a.coreterms["http://rs.tdwg.org/dwc/terms/continent"] new_continent,b.continent old_continent,
  a.coreterms["http://rs.tdwg.org/dwc/terms/year"] new_year,b.year old_year,
  a.coreterms["http://rs.tdwg.org/dwc/terms/month"] new_month,b.month old_month,
  a.coreterms["http://rs.tdwg.org/dwc/terms/day"] new_day,b.day old_day,
  a.coreterms["http://rs.tdwg.org/dwc/terms/decimalLatitude"] new_decimalLatitude,b.decimallatitude old_decimallatitude,
  a.coreterms["http://rs.tdwg.org/dwc/terms/decimalLongitude"] new_decimalLongitude,b.decimallongitude old_decimallongitude,
  a.coreterms["http://rs.tdwg.org/dwc/terms/collectionCode"] new_collectioncode,b.collectioncode old_collectioncode,
  a.coreterms["http://rs.tdwg.org/dwc/terms/eventTime"] new_eventtime,b.eventtime old_eventtime,
  a.coreterms["http://rs.tdwg.org/dwc/terms/eventDate"] new_eventdate,b.eventdate old_eventdate,
  <.....other interested columns ...>
  FROM newpipelineinterpreted_{datasetid} a JOIN oldpipelineinterpreted_{datasetid} b ON (a.id = b.occurrenceid);`